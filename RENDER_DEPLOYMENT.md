# ðŸš€ Render Backend Deployment Guide

## Overview
Deploy VILLEN Music backend to Render.com with automatic deployment on git push.

## Current Configuration
- **Service**: villen-music-backend
- **Platform**: Python 3.9.0
- **Region**: Singapore
- **Build Command**: `./backend/build.sh`
- **Start Command**: `cd backend && gunicorn core.wsgi`
- **Web Concurrency**: 4 workers

## Prerequisites
1. Render.com account (https://render.com)
2. GitHub repository connected to Render
3. Environment variables configured

## Deployment Steps

### Step 1: Connect Repository to Render

1. Go to https://dashboard.render.com
2. Click "New +" â†’ "Web Service"
3. Select "Deploy from GitHub"
4. Choose repository: `villen-music`
5. Click "Connect"

### Step 2: Configure Service

| Setting | Value |
|---------|-------|
| **Name** | villen-music-backend |
| **Environment** | Python 3 |
| **Build Command** | `./backend/build.sh` |
| **Start Command** | `cd backend && gunicorn core.wsgi` |
| **Instance Type** | Standard (free or paid) |
| **Region** | Singapore |

### Step 3: Set Environment Variables

In Render Dashboard â†’ Settings â†’ Environment:

```env
PYTHON_VERSION=3.9.0
SECRET_KEY=<auto-generated or paste existing>
DEBUG=False
WEB_CONCURRENCY=4
ALLOWED_HOSTS=villen-music.onrender.com
DATABASE_URL=<PostgreSQL URL if using external DB>
```

### Step 4: Deploy

#### Option A: Automatic Deployment (Recommended)
- Push to main branch:
  ```bash
  git add .
  git commit -m "Deploy backend to Render"
  git push origin main
  ```
- Render automatically builds and deploys

#### Option B: Manual Deployment
1. In Render Dashboard
2. Click "Manual Deploy" â†’ "Latest Commit"
3. Watch deployment logs

### Step 5: Verify Deployment

After deployment completes:

```bash
# Check health endpoint
curl https://villen-music.onrender.com/health/

# Expected response:
# {"status": "healthy", "version": "1.4.2"}

# Check API
curl https://villen-music.onrender.com/api/trending/
```

## Build Process

The `backend/build.sh` script:
1. Installs Python dependencies from `requirements.txt`
2. Collects static files (WhiteNoise)
3. Runs database migrations
4. Prepares for production

## Environment Variables Explained

| Variable | Purpose | Example |
|----------|---------|---------|
| `SECRET_KEY` | Django secret key (auto-generated) | auto |
| `DEBUG` | Debug mode (must be False in production) | False |
| `PYTHON_VERSION` | Python version to use | 3.9.0 |
| `WEB_CONCURRENCY` | Gunicorn worker processes | 4 |
| `ALLOWED_HOSTS` | Allowed hostnames | villen-music.onrender.com |
| `DATABASE_URL` | PostgreSQL connection string | postgres://... |

## Production Settings Enabled

âœ… `DEBUG=False` - No debug toolbar in production
âœ… `CSRF_COOKIE_SECURE=True` - HTTPS only
âœ… `SESSION_COOKIE_SECURE=True` - HTTPS only
âœ… `CSRF_COOKIE_HTTPONLY=True` - No JS access
âœ… `SESSION_COOKIE_HTTPONLY=True` - No JS access
âœ… `SECURE_SSL_REDIRECT=True` - Force HTTPS
âœ… `HSTS_SECONDS=31536000` - 1 year HSTS

## Monitoring Deployment

### Real-time Logs
```bash
# In Render Dashboard:
# Services â†’ villen-music-backend â†’ Logs
```

### Common Issues & Solutions

**Issue**: Build fails with "permission denied"
```bash
# Solution: Make build.sh executable
chmod +x backend/build.sh
git add backend/build.sh
git push origin main
```

**Issue**: Static files not serving
```bash
# Check: WhiteNoise is configured in settings.py
# Check: STATIC_ROOT and STATIC_URL are set correctly
# Solution: Clear cache and redeploy
```

**Issue**: Database migrations fail
```bash
# Check: DATABASE_URL environment variable is set
# Check: Database exists and is accessible
# Solution: Manually run migrations via SSH (if available)
```

**Issue**: Port binding error
```bash
# Render automatically assigns PORT environment variable
# Gunicorn uses: --bind 0.0.0.0:$PORT
# Check: startCommand in render.yaml includes $PORT
```

## Scaling

### Increase Concurrency
In Render Dashboard â†’ Settings:
```
WEB_CONCURRENCY=8  # More workers
```

### Use Paid Instance
- Render free instances sleep after 15 minutes of inactivity
- Upgrade to Standard or Pro for always-on service

## Database

### Option 1: PostgreSQL on Render
1. Create PostgreSQL database on Render
2. Copy connection string to `DATABASE_URL`
3. Run migrations

### Option 2: External PostgreSQL
1. Set `DATABASE_URL` to your PostgreSQL server
2. Ensure network access from Render

### Option 3: SQLite (Default)
- Uses SQLite for development
- Not recommended for production
- Switch to PostgreSQL for scaling

## Rollback Procedure

If deployment fails:

1. In Render Dashboard
2. Go to Deployments
3. Select previous successful deployment
4. Click "Rollback"

## Health Checks

The application includes health check endpoint:
```
GET /health/
```

Returns:
```json
{
  "status": "healthy",
  "version": "1.4.2",
  "database": "connected",
  "cache": "operational"
}
```

## Next Steps

After backend deployment:

1. âœ… Test API endpoints
2. âœ… Test authentication flow
3. âœ… Monitor error logs
4. âœ… Deploy frontend to Vercel/Netlify
5. âœ… Deploy mobile app to app stores

## Support

### Official Render Docs
- https://render.com/docs

### Troubleshooting
- Check deployment logs in Render dashboard
- Review build.sh script
- Verify environment variables
- Test locally before pushing

## Deployment Checklist

- [ ] GitHub repository connected to Render
- [ ] render.yaml configured correctly
- [ ] backend/build.sh is executable
- [ ] All environment variables set
- [ ] DEBUG=False in production
- [ ] SECRET_KEY generated
- [ ] Database configured (if using PostgreSQL)
- [ ] Health endpoint working
- [ ] API endpoints responding
- [ ] Frontend can connect to API
- [ ] CORS configured correctly
- [ ] SSL certificate installed (auto)
- [ ] Logs being monitored
- [ ] Rollback procedure tested

## Estimated Deployment Time

- First deployment: 5-10 minutes
- Subsequent deployments: 2-3 minutes
- Health checks: 30 seconds
- Total: ~10-15 minutes for first full deployment

---

**Version**: 1.4.2
**Last Updated**: January 24, 2026
**Status**: Ready for Production
